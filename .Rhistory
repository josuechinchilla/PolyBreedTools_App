return(A.mat)
}
}
library(shiny); runApp('Desktop/test.R')
runApp('Desktop/test.R')
library(shiny); runApp('test.R')
runApp('test.R')
runApp('test.R')
runApp('test.R')
library(shiny); runApp('test.R')
library(breedTools)
library(scales)
library(tidyverse)
# read in data
reference = read.table("~/Desktop/BreedToolspoly_test/blueberry_ref.txt", header = T, row.names = 1, sep = "\t")
runApp('test.R')
# Write final results
write.table(
pred_results_formatted,
"honeybee_regression_results_2010_paper_sets.txt",
col.names = TRUE,
sep = "\t",
quote = FALSE,
row.names = FALSE
)
require(shiny)
require(viridis)
require(BIGr)
require(scales)
require(tidyverse)
require(openxlsx)
#### Helper Functions ####
format_percent <- function(x) {
percent_format(accuracy = 0.1)(x)
}
#### UI ####
ui <- fluidPage(
tags$head(
tags$style(HTML("
.header-img {
text-align: center;
margin-bottom: 20px;
}
.header-img img {
max-width: 80%;
height: auto;
}
"))
),
div(class = "header-img",
img(src = "logos.png", alt = "Logos")
),
titlePanel("PolyBreedTools App: Estimate breed/line composition for any ploidy"),
fluidRow(
column(12,
wellPanel(
HTML('
<ul>
<li>This tool was developed by <strong>Breeding Insight</strong>.</li>
<li>It estimates the breed/line composition from genotype samples using methods from
<a href="https://www.animalsciencepublications.org/publications/tas/articles/1/1/36" target="_blank">Funkhouser et al. (2017)</a>.
</li>
<li><strong>Input files:</strong>
<ul>
<li><strong>Reference panel (.txt):</strong> SNPs in columns, samples in rows, first three columns: <code>ID</code>, <code>ref</code>, <code>alt</code></li>
<li><strong>Reference IDs (.txt):</strong> A two-column table (Line, ID) with header</li>
<li><strong>Genotype file (.txt):</strong> SNPs in rows, same format as reference</li>
</ul>
</li>
<li><strong>Ploidy:</strong> Enter the ploidy level of the organism.</li>
</ul>
')
)
)
),
sidebarLayout(
sidebarPanel(
fileInput("reference_file", "Upload Reference Genotypes (.txt)", accept = ".txt"),
fileInput("ref_ids_file", "Upload Reference IDs (.txt)", accept = ".txt"),
fileInput("validation_file", "Upload Genotypes to Test (.txt)", accept = ".txt"),
numericInput("ploidy", "Ploidy", value = 2, min = 1, max = 10, step = 1),
actionButton("run", "Run Estimation"),
br(), br(),
downloadButton("download_results", "Download Excel Results")
),
mainPanel(
tabsetPanel(
tabPanel("Results Table", DT::dataTableOutput("preview")),
tabPanel("Ancestry Plot", plotOutput("bar_plot"))
),
verbatimTextOutput("status")
)
)
)
#### SERVER ####
server <- function(input, output, session) {
result_data <- reactiveVal(NULL)
result_filename <- reactiveVal(NULL)
observeEvent(input$run, {
req(input$reference_file, input$ref_ids_file, input$validation_file, input$ploidy)
output$status <- renderText("Running estimation...")
# Load and process reference genotype matrix
reference_raw <- read.table(
input$reference_file$datapath,
, header = T, row.names = 1, sep = "\t")
# Read reference genotypes
reference <- read.table(
input$reference_file$datapath,
header = TRUE,
row.names = 1,
sep = "\t"
)
# Read reference IDs
reference_ids <- read.table(
input$ref_ids_file$datapath,
header = TRUE,
row.names = 1,
sep = "\t"
)
ref_ids <- lapply(as.list(reference_ids), as.character)
# Load and process validation genotype matrix
validation_raw <- read.table(
input$validation_file$datapath,
header = TRUE,
sep = "\t"
)
validation <- validation_raw %>%
column_to_rownames(var = "ID") %>%
as.data.frame()
# Estimate allele frequencies
freq <- BIGr:::allele_freq_poly(reference, ref_ids, ploidy = input$ploidy)
# Predict ancestry composition
prediction <- as.data.frame(BIGr:::solve_composition_poly(validation, freq, ploidy = input$ploidy)) %>%
select(-R2) %>%
rename(
`RHB content` = RHB,
`non-RHB content` = non.RHB
)
columns_to_select <- c("RHB content", "non-RHB content")
pred_results <- prediction %>%
rownames_to_column(var = "ID") %>%
mutate(
across(-ID, ~format_percent(.)),
`Predicted line` = columns_to_select[max.col(select(., all_of(columns_to_select)), ties.method = "first")]
)
result_data(pred_results)
# Save Excel file
date_str <- format(Sys.Date(), "%Y-%m-%d")
filename <- paste0("RHB_estimation_", date_str, ".xlsx")
temp_path <- file.path(tempdir(), filename)
result_filename(temp_path)
write.xlsx(pred_results, file = temp_path, rowNames = FALSE)
# Render results table
output$preview <- DT::renderDataTable({
DT::datatable(pred_results, options = list(pageLength = 10))
})
# Prepare and render plot
pred_results_long <- prediction %>%
rownames_to_column(var = "ID") %>%
pivot_longer(
cols = where(is.numeric),
names_to = "category",
values_to = "percent"
)
output$bar_plot <- renderPlot({
ggplot(pred_results_long, aes(x = ID, y = percent, fill = category)) +
geom_bar(stat = "identity") +
scale_fill_viridis_d(option = "D") +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(
x = "Individual ID",
y = "Ancestry Proportion",
fill = "Line"
) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
})
output$status <- renderText("Estimation complete. File ready for download.")
})
output$download_results <- downloadHandler(
filename = function() {
basename(result_filename())
},
content = function(file) {
file.copy(result_filename(), file)
}
)
}
shinyApp(ui, server)
# Predict ancestry composition
prediction <- as.data.frame(BIGr:::solve_composition_poly(validation, freq, ploidy = input$ploidy)) %>%
select(-R2) %>%
rename(
`RHB content` = RHB,
`non-RHB content` = non.RHB
)
clear
# Estimate allele frequencies
freq <- BIGr:::allele_freq_poly(reference, ref_ids, ploidy = input$ploidy)
# Load and process reference genotype matrix
reference_raw <- read.table(
input$reference_file$datapath,
, header = T, sep = "\t")
shinyApp(ui, server)
runApp('test.R')
runApp('test.R')
runApp('test.R')
runApp(Desktop/test.R)
runApp(~Desktop/test.R)
setwd("~/Desktop")
runApp('test.R')
setwd("~/Desktop/BreedTools_App")
runApp()
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
shiny::runApp('app')
setwd("~/Desktop/Max")
setwd("~/Desktop/Max")
library(readxl)
library(ggplot2)
library(dplyr)
# 1. Read the data
df <- read_excel("PCA_data.xlsx")
# 2. Separate species from numeric variables
species <- df$Species
df_numeric <- df %>% select(-Species)
# 3. Run PCA
pca_res <- prcomp(df_numeric, scale. = TRUE)
# 4. Extract PCA coordinates
pca_df <- as.data.frame(pca_res$x)
pca_df$Species <- species
# 5. Function to plot any two PCs
plot_pc <- function(pc_x, pc_y) {
ggplot(pca_df, aes_string(x = pc_x, y = pc_y, color = "Species")) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(title = paste(pc_x, "vs", pc_y),
x = pc_x,
y = pc_y) +
theme(legend.position = "right")
}
# 6. Plots
plot_pc("PC1", "PC2")
plot_pc("PC1", "PC3")
plot_pc("PC2", "PC3")
View(pca_df)
View(pca_res)
summary(pca_res)
library(readxl)
library(ggplot2)
library(dplyr)
# 1. Read the data
df <- read_excel("PCA_data.xlsx")
# 2. Separate species from numeric variables
species <- df$Species
df_numeric <- df %>% select(-Species)
# 3. Run PCA
pca_res <- prcomp(df_numeric, scale. = TRUE)
# 4. Variance explained (%)
variance_explained <- (pca_res$sdev^2) / sum(pca_res$sdev^2) * 100
# 5. PCA coordinates
pca_df <- as.data.frame(pca_res$x)
pca_df$Species <- species
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title = title_pc1_pc2,
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 2: PC1 vs PC3 ----
ggplot(pca_df, aes(x = PC1, y = PC3, color = Species)) +
geom_point(size = 2) +
stat_ellipse(aes(group = Species), level = 0.99) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 2: PC1 vs PC3 ----
ggplot(pca_df, aes(x = PC1, y = PC3, color = Species)) +
geom_point(size = 2) +
stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 2: PC1 vs PC3 ----
ggplot(pca_df, aes(x = PC1, y = PC3, color = Species)) +
geom_point(size = 2) +
#stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 2: PC1 vs PC3 ----
ggplot(pca_df, aes(x = PC1, y = PC3, color = Species)) +
geom_point(size = 2) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 3: PC2 vs PC3 ----
ggplot(pca_df, aes(x = PC2, y = PC3, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC2 (", round(variance_explained[2], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.99) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 3) +
stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1) +
#stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
#stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
#stat_ellipse(aes(group = Species), level = 0.90) +
# theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
#stat_ellipse(aes(group = Species), level = 0.90) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
#stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.99) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 1: PC1 vs PC2 ----
ggplot(pca_df, aes(x = PC1, y = PC2, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC2 (", round(variance_explained[2], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 2: PC1 vs PC3 ----
ggplot(pca_df, aes(x = PC1, y = PC3, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC1 (", round(variance_explained[1], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
# ---- Plot 3: PC2 vs PC3 ----
ggplot(pca_df, aes(x = PC2, y = PC3, color = Species)) +
geom_point(size = 1.5) +
stat_ellipse(aes(group = Species), level = 0.95) +
theme_minimal() +
labs(
title =  "PCA for Trachycarpus Species",
x = paste0("PC2 (", round(variance_explained[2], 1), "%)"),
y = paste0("PC3 (", round(variance_explained[3], 1), "%)")
) +
theme(legend.position = "right")
shiny::runApp('app')
runApp('app')
shiny::runApp('app')
